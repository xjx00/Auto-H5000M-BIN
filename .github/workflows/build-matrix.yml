name: OpenWrt Matrix Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * 0'

permissions:
  contents: write

jobs:
  feeds:
    runs-on: ubuntu-22.04
    outputs:
      feeds_cache_key: ${{ steps.cache-feeds.outputs.cache-primary-key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Clone source
        run: |
          if [ ! -d immortalwrt/.git ]; then
            git clone --depth=1 --single-branch -b mt798x-mt799x-6.6-mtwifi https://github.com/padavanonly/immortalwrt-mt798x-24.10 immortalwrt
          fi
      - name: Cache feeds
        id: cache-feeds
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/feeds
            feeds.conf.default
          key: ${{ runner.os }}-feeds-${{ github.run_id }}-${{ hashFiles('feeds.conf.default') }}
      - name: Update feeds
        run: |
          cd immortalwrt
          cp ../feeds.conf.default feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

  toolchain:
    needs: feeds
    runs-on: ubuntu-22.04
    outputs:
      toolchain_cache_key: ${{ steps.cache-toolchain.outputs.cache-primary-key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/feeds
            feeds.conf.default
          key: ${{ needs.feeds.outputs.feeds_cache_key }}
      - name: Cache toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: staging_dir/toolchain-*
          key: ${{ runner.os }}-toolchain-${{ hashFiles('feeds.conf.default') }}
      - name: Build toolchain
        run: |
          make toolchain/install -j$(nproc)

  build:
    needs: toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/feeds
            feeds.conf.default
          key: ${{ needs.feeds.outputs.feeds_cache_key }}
      - name: Restore toolchain cache
        uses: actions/cache@v4
        with:
          path: staging_dir/toolchain-*
          key: ${{ needs.toolchain.outputs.toolchain_cache_key }}
      - name: Cache build_dir
        uses: actions/cache@v4
        with:
          path: build_dir
          key: ${{ runner.os }}-builddir-${{ github.run_id }}

      - name: 修复依赖和 AdGuardHome 编译问题
        run: |
          # 1. 移除有问题的包
          rm -rf package/feeds/packages/exim 2>/dev/null || true
          rm -rf package/feeds/packages/onionshare-cli 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-event 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-interface 2>/dev/null || true
          # 2. ndisc6 优先用源码自带版本，移除 feed 中重复
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          # 3. 修复 kmod-mhi-wwan 依赖
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          if [ -f "$QMODEM_MK" ]; then
            sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true
            sed -i 's/+kmod-mhi-wwan/+PACKAGE_luci-app-qmodem_GENERIC_MHI_PCIe_DRIVER:kmod-mhi-wwan/g' "$QMODEM_MK" || true
          fi
          # 4. 移除有问题的 python 依赖
          rm -rf package/feeds/packages/python-gevent 2>/dev/null || true
          rm -rf package/feeds/packages/python-twisted 2>/dev/null || true
          # 5. 修复 mt_hwifi 驱动依赖警告
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          if [ -f "$MT_HWIFI_MK" ]; then
            sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true
          fi
          # 6. 修复 AdGuardHome 安装冲突
          AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
          if [ -f "$AGH_LUCI_SCRIPT" ]; then
            sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
          fi
          AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
          if [ -f "$AGH_LUCI_INIT" ]; then
            sed -i '/^#!/a\
            [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
          fi
          AGH_INIT="package/feeds/packages/adguardhome/files/etc/init.d/AdGuardHome"
          if [ -f "$AGH_INIT" ]; then
            sed -i '/^#!/a\
            # 清理冲突的 /usr/bin/AdGuardHome 路径\
            [ -e /usr/bin/AdGuardHome ] && rm -rf /usr/bin/AdGuardHome\
            mkdir -p /usr/bin/AdGuardHome' "$AGH_INIT" || true
          fi
          rm -rf package/feeds/packages/adguardhome/files/usr/bin/AdGuardHome 2>/dev/null || true
      - name: Append custom packages config
        run: |
          cat h5000m.config >> .config
          make defconfig
      - name: Build firmware
        run: |
          make -j$(nproc)
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: bin/targets

  ipk:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore build_dir cache
        uses: actions/cache@v4
        with:
          path: build_dir
          key: ${{ runner.os }}-builddir-${{ github.run_id }}
      - name: Upload ipk
        uses: actions/upload-artifact@v4
        with:
          name: ipk
          path: bin/packages
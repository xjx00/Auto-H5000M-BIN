name: Build ImmortalWrt H5000M
on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: true
        type: boolean
      enable_homeproxy:
        description: 'å¯ç”¨ HomeProxy'
        required: false
        default: false
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: true
        type: boolean
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: true
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: true
        type: boolean
      enable_smartdns:
        description: 'å¯ç”¨ SmartDNS'
        required: false
        default: false
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: true
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆ) - ä¸æ—§ç‰ˆäº’æ–¥'
        required: false
        default: true
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ) - ä¸æ–°ç‰ˆäº’æ–¥'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ç¯å¢ƒæ¸…ç†å’Œå‡†å¤‡
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ..."
          df -h
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f || true
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android \
            /opt/ghc /etc/mysql /etc/php /usr/local/share/boost /usr/share/swift \
            /opt/hostedtoolcache /usr/local/.ghcup /usr/local/graalvm /imagegeneration 2>/dev/null || true
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true
          sudo apt-get clean && sudo apt-get autoclean && sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /var/log/* 2>/dev/null || true
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
          df -h

      - name: ç¼“å­˜ç¼–è¯‘å™¨
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-ccache-

      - name: å…‹éš†æºç 
        run: |
          if [ -d "$SOURCE_DIR/.git" ]; then
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          fi
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: è®¾ç½® feeds
        run: |
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi
          ./scripts/feeds update -a 2>&1 | tail -20 || echo "âš ï¸ feeds æ›´æ–°å¤±è´¥ï¼Œç»§ç»­..."
          ./scripts/feeds install -a -f 2>&1 | tail -20 || echo "âš ï¸ feeds å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          echo "âœ… Feeds è®¾ç½®å®Œæˆ"

      - name: ä¸‹è½½å¹¶åˆå¹¶åŸºç¡€é…ç½®
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¥ ä¸‹è½½åŸºç¡€é…ç½®..."
          curl -fsSL "$CONFIG_URL" -o base.config || {
            echo "âš ï¸ è¿œç¨‹é…ç½®ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°é…ç½®..."
            if [ ! -f "defconfig/mt7987_mt7992.config" ]; then
              echo "âŒ æ— æ³•æ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
              exit 1
            fi
            cp defconfig/mt7987_mt7992.config base.config
          }
          
          # åˆå¹¶é…ç½®
          cat base.config > .config
          if [ -f "$GITHUB_WORKSPACE/h5000m.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.config" >> .config
            echo "âœ… å·²åº”ç”¨å®šåˆ¶åŒ–é…ç½®"
          fi

      - name: åº”ç”¨æ’ä»¶é…ç½®
        run: |
          cd $SOURCE_DIR
          
          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModem æ—§ç‰ˆï¼"
            exit 1
          fi
          
          # å®šä¹‰é…ç½®å‡½æ•°
          enable_pkg() { echo "CONFIG_PACKAGE_$1=y" >> .config; }
          disable_pkg() { echo "# CONFIG_PACKAGE_$1 is not set" >> .config; }
          
          # åº”ç”¨å„ä¸ªæ’ä»¶é…ç½®
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            enable_pkg "luci-app-adguardhome"
            enable_pkg "adguardhome"
          else
            disable_pkg "luci-app-adguardhome"
            disable_pkg "adguardhome"
          fi
          
          [ "${{ inputs.enable_homeproxy }}" = "true" ] && enable_pkg "luci-app-homeproxy"
          
          if [ "${{ inputs.enable_openclash }}" = "true" ]; then
            enable_pkg "luci-app-openclash"
            enable_pkg "bash"
            enable_pkg "dnsmasq-full"
            enable_pkg "curl"
            enable_pkg "ca-bundle"
            enable_pkg "ip-full"
            enable_pkg "kmod-nft-tproxy"
            enable_pkg "luci-compat"
          else
            disable_pkg "luci-app-openclash"
            disable_pkg "kmod-nft-tproxy"
            disable_pkg "ip-full"
          fi
          
          if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
            enable_pkg "mihomo"
            enable_pkg "luci-app-mihomo"
          fi
          
          [ "${{ inputs.enable_upnp }}" = "true" ] && enable_pkg "luci-app-upnp" || disable_pkg "luci-app-upnp"
          
          if [ "${{ inputs.enable_vlmcsd }}" = "true" ]; then
            enable_pkg "vlmcsd"
            enable_pkg "luci-app-vlmcsd"
          else
            disable_pkg "vlmcsd"
            disable_pkg "luci-app-vlmcsd"
          fi
          
          if [ "${{ inputs.enable_smartdns }}" = "true" ]; then
            enable_pkg "smartdns"
            enable_pkg "luci-app-smartdns"
          fi
          
          if [ "${{ inputs.enable_mosdns }}" = "true" ]; then
            enable_pkg "mosdns"
            enable_pkg "luci-app-mosdns"
          else
            disable_pkg "mosdns"
            disable_pkg "luci-app-mosdns"
          fi
          
          if [ "${{ inputs.enable_dockerman }}" = "true" ]; then
            enable_pkg "docker"
            enable_pkg "luci-app-dockerman"
          fi
          
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            enable_pkg "luci-app-qmodem-next"
          elif [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            enable_pkg "luci-app-qmodem"
          fi
          
          if [ "${{ inputs.enable_mwan }}" = "true" ]; then
            enable_pkg "mwan3"
            enable_pkg "luci-app-mwan3"
          fi
          
          make defconfig || true
          echo "âœ… æ’ä»¶é…ç½®å·²åº”ç”¨"

      - name: éªŒè¯é…ç½®
        run: |
          cd $SOURCE_DIR
          echo "ğŸ” éªŒè¯é…ç½®..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          check_pkg() {
            local pkg=$1
            if grep -q "CONFIG_PACKAGE_$pkg=y" .config; then
              echo "âœ… $2: å¯ç”¨"
            elif grep -q "# CONFIG_PACKAGE_$pkg is not set" .config; then
              echo "âš ï¸  $2: ç¦ç”¨"
            else
              echo "â“ $2: æœªé…ç½®"
            fi
          }
          
          check_pkg "luci-app-adguardhome" "AdGuardHome"
          check_pkg "luci-app-openclash" "OpenClash"
          check_pkg "luci-app-mihomo" "Mihomo"
          check_pkg "luci-app-mosdns" "MosDNS"
          check_pkg "docker" "Docker"
          check_pkg "mwan3" "MWAN"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¥ ä¸‹è½½ä¾èµ–..."
          for i in 1 2 3; do
            if make download -j16 2>&1 | tail -5; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              exit 0
            fi
            echo "âš ï¸  ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
            find dl -size -1024c -delete 2>/dev/null
            sleep 10
          done
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          if make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m 2>&1 | tee /tmp/build.log | tail -30; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make -j1 V=s 2>&1 | tail -50; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              exit 1
            fi
          fi

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: æ‰“åŒ…äº§ç‰©
        run: |
          mkdir -p artifacts
          cd $SOURCE_DIR
          
          if [ ! -d "bin/targets" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
            exit 1
          fi
          
          echo "ğŸ“¦ æ”¶é›†äº§ç‰©..."
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \; 2>/dev/null || true
          
          if [ -z "$(ls -A $GITHUB_WORKSPACE/artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… äº§ç‰©æ‰“åŒ…å®Œæˆ:"
          cd $GITHUB_WORKSPACE/artifacts
          ls -lh
          
          # ç”Ÿæˆæ¸…å•
          cat > MANIFEST.txt << EOF
          æ„å»ºä¿¡æ¯: ImmortalWrt H5000M
          æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          è¿è¡ŒID: ${{ github.run_id }}
          
          å¯ç”¨çš„åŠŸèƒ½:
          - AdGuardHome: ${{ inputs.enable_adguardhome }}
          - HomeProxy: ${{ inputs.enable_homeproxy }}
          - OpenClash: ${{ inputs.enable_openclash }}
          - Mihomo: ${{ inputs.enable_mihomo }}
          - UPnP: ${{ inputs.enable_upnp }}
          - VLMCSd: ${{ inputs.enable_vlmcsd }}
          - SmartDNS: ${{ inputs.enable_smartdns }}
          - MosDNS: ${{ inputs.enable_mosdns }}
          - DockerMan: ${{ inputs.enable_dockerman }}
          - QModem Next: ${{ inputs.enable_qmodem_next }}
          - QModem: ${{ inputs.enable_qmodem }}
          - MWAN: ${{ inputs.enable_mwan }}
          
          äº§ç‰©æ–‡ä»¶:
          EOF
          
          for file in *; do
            if [ "$file" != "MANIFEST.txt" ] && [ -f "$file" ]; then
              echo "- $(basename $file) ($(du -h $file | cut -f1))" >> MANIFEST.txt
            fi
          done

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt H5000M Build #${{ github.run_number }}
          body: |
            ğŸ‰ ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ
            
            ğŸ“¦ **å¯ç”¨çš„åŠŸèƒ½:**
            - AdGuardHome: ${{ inputs.enable_adguardhome }}
            - OpenClash: ${{ inputs.enable_openclash }}
            - Mihomo: ${{ inputs.enable_mihomo }}
            - MosDNS: ${{ inputs.enable_mosdns }}
            - DockerMan: ${{ inputs.enable_dockerman }}
            - MWAN: ${{ inputs.enable_mwan }}
            
            ğŸ”— æ›´å¤šè¯¦æƒ…è§ Artifacts
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}